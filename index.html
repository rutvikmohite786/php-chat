<!DOCTYPE html>
<html>

<head>
    <title>Secure Chat</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(to right, #f5f7fa, #c3cfe2);
            font-family: 'Segoe UI', sans-serif;
        }

        .chat-box .message {
            max-width: 70%;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.4;
        }

        .chat-box .you {
            background: #e0f7fa;
            align-self: end;
            border-bottom-right-radius: 0;
        }

        .chat-box .partner {
            background: #f1f1f1;
            align-self: start;
            border-bottom-left-radius: 0;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .input-group {
            position: relative;
        }

        #typingIndicator {
            display: none;
            position: absolute;
            bottom: 60px;
            left: 15px;
            font-size: 12px;
            color: gray;
        }

        .dark-mode {
            background: #333;
            color: #ddd;
        }

        .dark-mode .chat-box .you {
            background: #444;
        }

        .dark-mode .chat-box .partner {
            background: #555;
        }

        .dark-mode .navbar {
            background: #222;
        }

        .emoji-picker {
            position: absolute;
            bottom: 60px;
            left: 10px;
            background: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            display: none;
            border-radius: 10px;
            z-index: 1000;
            max-height: 150px;
            width: 260px;
            overflow-y: auto;
        }

        .border-primary {
            border: 4px solid #007bff !important;
        }
    </style>
</head>

<body>
    <!-- Dark Mode Toggle -->
    <div class="container">
        <button class="btn btn-secondary my-3" id="darkModeToggle"><i class="fas fa-moon"></i> Toggle Dark Mode</button>
    </div>

    <!-- Modal for name and avatar -->
    <!-- Modal for name and avatar -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true"
        data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-3">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="userModalLabel">👤 Join Chat</h5>
                </div>
                <div class="modal-body">
                    <input type="text" id="username" class="form-control mb-3 rounded-pill px-4 py-2"
                        placeholder="Your name" required />

                    <div class="d-flex justify-content-around mb-3">
                        <img src="man.png" class="avatar-select rounded-circle border" data-avatar="male"
                            style="cursor:pointer; width:150px;">
                        <img src="human.png" class="avatar-select rounded-circle border" data-avatar="female"
                            style="cursor:pointer; width:150px;">
                    </div>

                    <input type="hidden" id="avatarChoice" />

                    <div class="terms-box mb-3 p-3 border rounded"
                        style="height: 150px; overflow-y: auto; font-size: 14px;">
                        <p><strong>Terms and Conditions:</strong></p>
                        <p>1. You must be 18+ to use this service.</p>
                        <p>2. Do not use offensive or inappropriate language.</p>
                        <p>3. Respect other users and their privacy.</p>
                        <p>4. No spamming or promotion of third-party services.</p>
                        <p>5. Violators will be banned without warning.</p>
                        <p>6. We do not store any chat history.</p>
                        <p>7. Use at your own risk. The platform is provided as-is.</p>
                    </div>

                    <div class="form-check mb-3 text-start px-2">
                        <input class="form-check-input" type="checkbox" value="" id="termsCheck">
                        <label class="form-check-label" for="termsCheck">
                            I agree to the Terms & Conditions
                        </label>
                    </div>

                    <div class="text-center">
                        <button class="btn btn-dark px-4 rounded-pill" id="joinBtn" disabled>Join</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Chat container -->
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-md-8 shadow rounded bg-white px-0">

                <!-- Chat Header -->
                <div class="d-flex align-items-center px-4 py-3 border-bottom" id="partnerInfo" style="display:none;">
                    <img id="partnerAvatar" class="avatar me-3" />
                    <div>
                        <div class="fw-bold" id="partnerName"></div>
                        <div id="status" class="text-muted small">Connecting...</div>
                    </div>
                </div>

                <!-- Chat Body -->
                <div id="chat" class="chat-box px-3 py-3 d-flex flex-column gap-2 d-none"
                    style="height: 65vh; overflow-y: auto;">
                    <!-- Messages appear here -->
                </div>
                <div id="typing-status" class="text-muted mt-1"></div>

                <!-- Typing indicator -->

                <!-- Chat Input -->
                <!-- Emoji Picker -->


                <div class="input-group border-top d-none" id="messageControls">
                    <div id="typingIndicator"></div>

                    <div id="emojiPicker" class="emoji-picker">
                        <button class="btn btn-light btn-sm" data-emoji="😊">😊</button>
                        <button class="btn btn-light btn-sm" data-emoji="😂">😂</button>
                        <button class="btn btn-light btn-sm" data-emoji="❤️">❤️</button>
                        <button class="btn btn-light btn-sm" data-emoji="😢">😢</button>
                        <button class="btn btn-light btn-sm" data-emoji="😍">😍</button>
                        <button class="btn btn-light btn-sm" data-emoji="😎">😎</button>
                        <button class="btn btn-light btn-sm" data-emoji="🤔">🤔</button>
                        <button class="btn btn-light btn-sm" data-emoji="😡">😡</button>
                        <button class="btn btn-light btn-sm" data-emoji="😭">😭</button>
                        <button class="btn btn-light btn-sm" data-emoji="🤯">🤯</button>
                        <button class="btn btn-light btn-sm" data-emoji="🤩">🤩</button>
                        <button class="btn btn-light btn-sm" data-emoji="🤗">🤗</button>
                        <button class="btn btn-light btn-sm" data-emoji="💪">💪</button>
                        <button class="btn btn-light btn-sm" data-emoji="👋">👋</button>
                        <button class="btn btn-light btn-sm" data-emoji="🙏">🙏</button>
                        <button class="btn btn-light btn-sm" data-emoji="🔥">🔥</button>
                        <button class="btn btn-light btn-sm" data-emoji="💯">💯</button>
                        <button class="btn btn-light btn-sm" data-emoji="🌈">🌈</button>
                        <button class="btn btn-light btn-sm" data-emoji="🎉">🎉</button>
                        <button class="btn btn-light btn-sm" data-emoji="🍕">🍕</button>
                        <button class="btn btn-light btn-sm" data-emoji="🍔">🍔</button>
                        <button class="btn btn-light btn-sm" data-emoji="🍟">🍟</button>
                        <button class="btn btn-light btn-sm" data-emoji="🍩">🍩</button>
                        <button class="btn btn-light btn-sm" data-emoji="🐶">🐶</button>
                        <button class="btn btn-light btn-sm" data-emoji="🐱">🐱</button>
                        <button class="btn btn-light btn-sm" data-emoji="🐭">🐭</button>
                        <button class="btn btn-light btn-sm" data-emoji="🐰">🐰</button>
                        <button class="btn btn-light btn-sm" data-emoji="🦊">🦊</button>
                        <button class="btn btn-light btn-sm" data-emoji="🐼">🐼</button>
                    </div>
                    <input type="text" id="input" class="form-control border-0 px-4 py-3"
                        placeholder="Type a message..." style="border-radius: 0;">
                    <button class="btn btn-dark px-4" id="send">Send</button>
                    <button class="btn btn-outline-secondary px-2" id="emojiBtn"><i class="fas fa-smile"></i></button>
                </div>


            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <script>
        const SECRET_KEY = "mychatappkey458755!";
        const socket = io("http://localhost:3000");

        let userName = '';
        let userAvatar = '';
        let partnerName = '';
        let partnerAvatar = '';
        let currentRoom = null;
        let isDarkMode = false;

        socket.on('connect', function () {
            mySocketId = socket.id;
        });

        // Dark Mode Toggle
        $('#darkModeToggle').click(function () {
            $('body').toggleClass('dark-mode');
            isDarkMode = !isDarkMode;
        });

        // Modal logic
        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        modal.show();

        $('.avatar-select').click(function () {
            $('.avatar-select').removeClass('border border-primary');
            $(this).addClass('border border-primary');
            $('#avatarChoice').val($(this).data('avatar'));
            if ($('#termsCheck').is(':checked')) {
                $('#joinBtn').prop('disabled', !$('#username').val());
            }
        });

        $('#username').on('input', function () {
            if ($('#termsCheck').is(':checked')) {
                $('#joinBtn').prop('disabled', !$(this).val() || !$('#avatarChoice').val());
            }
        });

        $('#termsCheck').on('change', function () {
            if ($(this).is(':checked')) {
                $('#joinBtn').prop('disabled', !$('#username').val() || !$('#avatarChoice').val());
            } else {
                $('#joinBtn').prop('disabled', true);
            }
        });

        $('#joinBtn').click(function () {
            userName = $('#username').val().trim();
            userAvatar = $('#avatarChoice').val() === 'male'
                ? 'man.png'
                : 'human.png';

            socket.emit('user_info', { name: userName, avatar: userAvatar });
            modal.hide();
        });

        socket.on('waiting', msg => $('#status').text(msg));

        socket.on('room_created', data => {
            currentRoom = data.room;
            partnerName = data.partner.name;
            partnerAvatar = data.partner.avatar;

            $('#status').text("You're connected!");
            $('#partnerName').text(partnerName);
            $('#partnerAvatar').attr('src', partnerAvatar);
            $('#partnerInfo').removeClass('d-none');

            $('#chat').removeClass('d-none');
            $('#messageControls').removeClass('d-none');
        });

        $('#send').click(function () {
            $('#emojiPicker').hide();
            const message = $('#input').val().trim();
            if (!message || !currentRoom) return;

            const encrypted = CryptoJS.AES.encrypt(message, SECRET_KEY).toString();

            socket.emit('encrypted_message', {
                room: currentRoom,
                encrypted
            });

            $('#chat').append(`
            <div class="message you">
                ${message}
            </div>
        `);

            $('#input').val('');
            $('#chat').scrollTop($('#chat')[0].scrollHeight);
        });

        $('#input').on('keypress', function (e) {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                $('#send').click();
            }
        })

        socket.on('receive_encrypted', function (data) {
            const decrypted = CryptoJS.AES.decrypt(data.encrypted, SECRET_KEY).toString(CryptoJS.enc.Utf8);
            $('#chat').append(`
            <div class="message partner">
                ${decrypted}
            </div>
        `);
            $('#chat').scrollTop($('#chat')[0].scrollHeight);
        });

        // Typing indicator
        $('#input').on('input', function () {
            socket.emit('typing', currentRoom);
        });

        socket.on('partner_typing', function () {
            $('#typingIndicator').text(partnerName + ' is typing...')
            $('#typingIndicator').show();
            setTimeout(() => $('#typingIndicator').hide(), 3000);
        });

        socket.on('partner_disconnected', () => {
            $('#chat').append('<div class="text-muted text-center">' + partnerName + '   has disconnected.</div>');
            $('#messageControls').hide();
        });

        // Emoji Picker
        $('#emojiBtn').click(function () {
            $('#emojiPicker').toggle();
        });

        $('#emojiPicker button').click(function () {
            const emoji = $(this).data('emoji');
            $('#input').val($('#input').val() + emoji);
            // $('#emojiPicker').hide();
        });

        socket.on('seen_by_partner', function (senderId) {
            if (senderId === mySocketId) {
                $('.status').last().text('✓✓ Seen');
            }
        });
    </script>

</body>

</html>